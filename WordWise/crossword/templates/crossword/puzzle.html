{% load static %}

{% block content %}
<div class="container mx-auto px-8 py-8">
    <h1 class="text-2xl font-bold mb-4 text-center">Welcome to Crossword Game</h1>

    <div class="game-box">
        <!-- กริด crossword -->
        <div class="crossword-grid" id="crosswordGrid"></div>

        <!-- ตารางคำใบ้ -->
        <div class="hint-container">
            <h2 class="text-2xl font-bold mb-4" id="title-hint">Hint Table</h2>
            <div class="hint-table" id="hintTable">
                {% for word in words %}
                    <div class="hint-item" data-word="{{ word.word }}" data-index="{{ forloop.counter0 }}">
                        <strong>{{ forloop.counter }}.</strong> {{ word.meaning }}
                    </div>
                    <div class="answer" data-words="{{ word.word }}" data-index="{{ forloop.counter0 }}">
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <button id="checkButton" class="mt-4 px-4 py-2 bg-blue-500 text-white">Check</button>
</div>

<style>
    .game-box {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    .crossword-grid {
        display: grid;
        grid-template-columns: repeat(15, 30px);
        grid-template-rows: repeat(15, 30px);
        gap: 1px;
        background-color: #000;
        padding: 1px;
        border: 2px solid green;
    }
    .grid-cell {
        width: 30px;
        height: 30px;
        background-color: #fff;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .grid-cell input {
        width: 100%;
        height: 100%;
        border: none;
        text-align: center;
        font-size: 16px;
        text-transform: uppercase;
        background: transparent;
        outline: none;
    }
    .grid-cell input:focus {
        background-color: #e6f3ff;
    }
    .hint-container {
        width: 400px;
        margin-left: 40px;
    }
    .hint-table {
        background: wheat;
        width: 400px;
        height: 400px;
        overflow-y: auto;
    }
    .hint-item {
        color: black;
        text-align: left;
        padding: 20px;
        font-size: 18px;
    }
    #title-hint {
        text-align: center;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gridSize = 15;
        const grid = document.getElementById('crosswordGrid');

        let cells = {};
        // usedCells: key => array ของ orientation ที่เซลล์นั้นถูกใช้ (เช่น ['horizontal'], ['vertical'] หรือทั้งคู่)
        let usedCells = {};

        // สร้างกริด 15x15
        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.x = j;
                cell.dataset.y = i;

                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.pattern = "[A-Za-z]";
                input.title = "Only English letters allowed";
                input.addEventListener('input', function(e) {
                    if (!/^[a-zA-Z]$/.test(e.target.value)) {
                        e.target.value = "";
                    }
                });

                cell.appendChild(input);
                grid.appendChild(cell);
                cells[`${i},${j}`] = cell;
            }
        }

        // ดึงข้อมูลคำจาก .answer พร้อม data-index
        const allWordObjects = [];
        document.querySelectorAll('.answer').forEach(ans => {
            allWordObjects.push({
                index: parseInt(ans.dataset.index),
                word: ans.dataset.words
            });
        });

        function getRandomUniqueWords(wordList, count) {
            const shuffled = [...wordList].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // ฟังก์ชันรีเซ็ตกริดและ usedCells
        function resetGrid() {
            usedCells = {};
            for (let key in cells) {
                let cell = cells[key];
                cell.firstChild.value = '';
                cell.firstChild.readOnly = false;
                cell.style.backgroundColor = '#fff';
                const label = cell.querySelector('div');
                if (label) {
                    cell.removeChild(label);
                }
            }
        }

        // ฟังก์ชันตรวจสอบการวางคำ
        // ปรับให้ตรวจ adjacent cells เฉพาะกรณีที่เซลล์นั้นไม่ได้เกิด overlap อยู่แล้ว
        function isValidPlacement(row, col, word, direction) {
            // ตรวจสอบขอบเขตของคำ และตรวจสอบช่องที่อยู่นอกคำ (ด้านซ้าย-ขวาหรือบน-ล่างของคำ)
            if (direction === 'horizontal') {
                if (col + word.length > gridSize) return false;
                if (col > 0 && cells[`${row},${col-1}`].firstChild.value !== '') return false;
                if (col + word.length < gridSize && cells[`${row},${col+word.length}`].firstChild.value !== '') return false;
            } else {
                if (row + word.length > gridSize) return false;
                if (row > 0 && cells[`${row-1},${col}`].firstChild.value !== '') return false;
                if (row + word.length < gridSize && cells[`${row+word.length},${col}`].firstChild.value !== '') return false;
            }
            
            let hasPerpOverlap = false;
            // ตรวจสอบแต่ละตัวอักษรของคำ
            for (let i = 0; i < word.length; i++) {
                let newRow = row + (direction === 'vertical' ? i : 0);
                let newCol = col + (direction === 'horizontal' ? i : 0);
                let key = `${newRow},${newCol}`;
                let letterExpected = word[i].toUpperCase();
                let isOverlap = false;
                
                if (usedCells[key]) {
                    // ถ้าเซลล์นั้นมีการใช้ใน orientation เดียวกันแล้ว ให้ return false
                    if (usedCells[key].includes(direction)) {
                        return false;
                    } else {
                        // หากมีตัวอักษรในเซลล์ แต่ไม่ตรงกับที่คาดไว้
                        if (cells[key].firstChild.value && cells[key].firstChild.value !== letterExpected) {
                            return false;
                        }
                        isOverlap = true;
                        hasPerpOverlap = true;
                    }
                }
                
                // หากไม่เกิด overlap ให้ตรวจสอบ adjacent cells ในทิศทางตั้งฉาก
                if (!isOverlap) {
                    if (direction === 'horizontal') {
                        // ตรวจสอบด้านบนและด้านล่างของตัวอักษร
                        if (newRow > 0 && cells[`${newRow-1},${newCol}`].firstChild.value !== '') return false;
                        if (newRow < gridSize - 1 && cells[`${newRow+1},${newCol}`].firstChild.value !== '') return false;
                    } else { // vertical
                        if (newCol > 0 && cells[`${newRow},${newCol-1}`].firstChild.value !== '') return false;
                        if (newCol < gridSize - 1 && cells[`${newRow},${newCol+1}`].firstChild.value !== '') return false;
                    }
                }
            }
            // ถ้ามีคำวางอยู่แล้ว (ใน usedCells) ให้ต้องมีอย่างน้อยหนึ่งจุด overlap แบบตั้งฉาก
            if (Object.keys(usedCells).length > 0 && !hasPerpOverlap) return false;
            return true;
        }

        // ฟังก์ชันสุ่มตำแหน่งที่ถูกต้องสำหรับวางคำ
        function getValidPosition(word, maxAttempts = 100) {
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                let row = Math.floor(Math.random() * gridSize);
                let col = Math.floor(Math.random() * gridSize);
                let direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
                if (isValidPlacement(row, col, word, direction)) {
                    return { row, col, direction, success: true };
                }
            }
            return { success: false };
        }

        // updateUsedCells: บันทึกตำแหน่งที่วางคำพร้อม orientation
        function updateUsedCells(row, col, word, direction) {
            for (let i = 0; i < word.length; i++) {
                let newRow = row + (direction === 'vertical' ? i : 0);
                let newCol = col + (direction === 'horizontal' ? i : 0);
                let key = `${newRow},${newCol}`;
                if (usedCells[key]) {
                    if (!usedCells[key].includes(direction)) {
                        usedCells[key].push(direction);
                    }
                } else {
                    usedCells[key] = [direction];
                }
            }
        }

        // ฟังก์ชันวางคำในกริด
        function placeWord(word, clueNumber) {
            let position = getValidPosition(word);
            if (position.success) {
                let { row, col, direction } = position;
                for (let i = 0; i < word.length; i++) {
                    let newRow = row + (direction === 'vertical' ? i : 0);
                    let newCol = col + (direction === 'horizontal' ? i : 0);
                    let key = `${newRow},${newCol}`;
                    let cell = cells[key];
                    if (cell && cell.firstChild.value === '') {
                        cell.firstChild.value = word[i].toUpperCase();
                    }
                }
                updateUsedCells(row, col, word, direction);
                // ใส่หมายเลขที่เซลล์เริ่มต้น
                let startCell = cells[`${row},${col}`];
                if (startCell) {
                    const label = document.createElement('div');
                    label.innerText = clueNumber;
                    label.style.position = 'absolute';
                    label.style.fontSize = '10px';
                    label.style.color = 'black';
                    label.style.top = '2px';
                    label.style.left = '2px';
                    startCell.appendChild(label);
                }
                return true;
            }
            return false;
        }

        // attemptPlacement: วางคำทั้งหมดจาก selectedWordObjects ลงกริด
        function attemptPlacement(selectedWordObjects) {
            resetGrid();
            for (let i = 0; i < selectedWordObjects.length; i++) {
                if (!placeWord(selectedWordObjects[i].word, selectedWordObjects[i].index + 1)) {
                    return false;
                }
            }
            // เปลี่ยนสีช่องที่ไม่มีตัวอักษรให้เป็นสีดำ
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    let cell = cells[`${i},${j}`];
                    if (cell.firstChild.value === '') {
                        cell.style.backgroundColor = 'black';
                    }
                }
            }
            return true;
        }

        // Outer loop: สุ่มเลือกชุดคำจนกว่าจะวางได้ครบ
        let success = false;
        let totalAttempts = 0;
        const MAX_TOTAL_ATTEMPTS = 1000;
        let selectedWordObjects = [];
        while (!success && totalAttempts < MAX_TOTAL_ATTEMPTS) {
            // สุ่มเลือก 5 คำจาก allWordObjects
            selectedWordObjects = getRandomUniqueWords(allWordObjects, 5);
            // เรียงลำดับตาม index (เพื่อให้หมายเลขใน hint table ตรงกัน)
            selectedWordObjects.sort((a, b) => a.index - b.index);
            if (attemptPlacement(selectedWordObjects)) {
                success = true;
                break;
            }
            totalAttempts++;
        }
        if (!success) {
            alert('ไม่สามารถวางคำได้ครบ กรุณารีเฟรชหน้าเว็บเพื่อลองใหม่');
        }
    });
</script>

{% endblock %}